โ README.md (ฺฉู ูุงู ุฑุง ฺฉุงูู ูพุงฺฉ ฺฉู ู ุงู ุฑุง ุฌุงฺฏุฒู ฺฉู)
PasarGuard Admin Report ๐

PasarGuard Admin Report ฺฉ ุงุจุฒุงุฑ ฺฏุฒุงุฑุดโฺฏุฑ ุฏูู ู ุถุฏ ุถุฑุฑ ูุงู ุจุฑุง PasarGuard / Marzban Panel ุงุณุช ฺฉู ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฏุฒุงุฑุดโูุง ุฑูุฒุงูู / ููุชฺฏ / ูุงูุงูู ุฑุง ุงุฒ ุฏุชุงุจุณ ูโุฎูุงูุฏ ู ุฏุฑ ุชูฺฏุฑุงู ุงุฑุณุงู ูโฺฉูุฏ.

โ ูุฏู ุงุตู: ุฌููฺฏุฑ ุงุฒ ุถุฑุฑ ูุงู
โ ฺูู ูุฑฺฏููู ุณุงุฎุช ฺฉุงุฑุจุฑ ุฌุฏุฏุ ุงูุฒุงุด ุญุฌูุ ุฑุณุช ูุตุฑูุ ู ูุงูุญุฏูุฏ ฺฉุฑุฏู ุญุฌู (Unlimited) ุฏุฑ ฺฏุฒุงุฑุดโูุง ุซุจุช ู ููุงุด ุฏุงุฏู ูโุดูุฏ.

โจ ุงูฺฉุงูุงุช ุงุตู
โ ฺฏุฒุงุฑุด ุฑูุฒุงูู (Daily)

ุจุฑุง ูุฑ ุงุฏูู ุจูโุตูุฑุช ุฌุฏุงฺฏุงูู ุงุฑุณุงู ูโุดูุฏ ู ุดุงูู ููุงุฑุฏ ุฒุฑ ุงุณุช:

ุณุงุฎุช ฺฉุงุฑุจุฑ ุฌุฏุฏ (INSERT) โ ูุญุงุณุจู ฺฉุงูู ุญุฌู ุณุงุฎุชูโุดุฏู

ุงูุฒุงุด ุญุฌู ฺฉุงุฑุจุฑ (CHANGE_LIMIT) โ ูุญุงุณุจู ููุท ุงุฎุชูุงู ุญุฌู ุฌุฏุฏ ู ูุจู (ููุท ุงฺฏุฑ ูุซุจุช ุจุงุดุฏ)

ุฑุณุช ูุตุฑู (RESET_USAGE) โ ูุญุงุณุจู ฺฉุงูู ุญุฌู ูพูู (ฺูู ฺฉุงุฑุจุฑ ุฏูุจุงุฑู ุญุฌู ฺฉุงูู ฺฏุฑูุชู)

ูุงูุญุฏูุฏ ฺฉุฑุฏู ุญุฌู (UNLIMITED) โ ููุงุด ุจู ุตูุฑุช unlimited

ุงูุฒุงุด ุฒูุงู (CHANGE_EXPIRE) โ ููุท ููุงุด extend (ูุฒูู ุญุฌู ูุฏุงุฑุฏ)

ุงฺฉุดูโูุง UPDATE ู DELETE โ ุฏุฑ ูุญุงุณุจู ูุงู ูุญุงุธ ููโุดููุฏ

โ ฺฏุฒุงุฑุด ููุชฺฏ (Weekly)

ุจุงุฒู ุฒูุงู: ุดูุจู ุชุง ุฌูุนู

ุจุฑุง ููู ุงุฏููโูุง ุฏุฑ ฺฉ ูพุงู ุงุฑุณุงู ูโุดูุฏ

ุนูุงูู ุจุฑ ุญุฌูุ ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู unlimited ู ูุณุช ุขูโูุง ููุงุด ุฏุงุฏู ูโุดูุฏ

โ ฺฏุฒุงุฑุด ูุงูุงูู (Monthly)

ุจุงุฒู ุฒูุงู: ูุงู ุดูุณ ูุจู

ุฏุฑ ุฑูุฒ ุงูู ูุฑ ูุงู ุดูุณ ุงุฌุฑุง ูโุดูุฏ

ุญุฌู ฺฉู ูุฑ ุงุฏูู + unlimitedโูุง ููุงุด ุฏุงุฏู ูโุดูุฏ

โ ููุงูู ูุญุงุณุจู ุฏูู (ุถุฏ ุถุฑุฑ ูุงู)

ุงู ุงุณฺฉุฑูพุช ููุท ุงฺฉุดูโูุง ุฑุง ูุญุงุณุจู ูโฺฉูุฏ ฺฉู ุงุซุฑ ูุงู ุฏุงุฑูุฏ:

Action ุฏุฑ ุฏุชุงุจุณ	ูุนู	ูุญุงุณุจู ูุงู
INSERT	ุณุงุฎุช ฺฉุงุฑุจุฑ ุฌุฏุฏ	ฺฉู data_limit_new
CHANGE_LIMIT	ุงูุฒุงุด/ุชุบุฑ ุญุฌู	ููุท new - old ุงฺฏุฑ ูุซุจุช ุจุงุดุฏ
RESET_USAGE	ุฑุณุช ูุตุฑู	ฺฉู data_limit_new
UNLIMITED	ูุงูุญุฏูุฏ ุดุฏู ุญุฌู	ููุท ููุงุด unlimited
CHANGE_EXPIRE	ุงูุฒุงุด ุฒูุงู	ููุท ููุงุด extend
UPDATE	ุขูพุฏุช ุณุณุชู	ูุงุฏุฏู ฺฏุฑูุชู ูโุดูุฏ
DELETE	ุญุฐู ฺฉุงุฑุจุฑ	ูุงุฏุฏู ฺฏุฑูุชู ูโุดูุฏ

โ Unlimited ุญุฌู ุฒูุงู ุงุณุช ฺฉู data_limit_new = 0 ุง NULL ุจุงุดุฏ.
โ๏ธ Unlimited ุฒูุงู (expire) ููู ูุณุช.

๐ ููููู ุฎุฑูุฌ (Example Output)
โ ฺฏุฒุงุฑุด ุฑูุฒุงูู
Daily report - 1404-10-06
Admin: admin58586

- ali: +50.00 GB
- reza2022: unlimited
- m12: +20.00 GB | reset
- userx: extend

Total: 70.00 GB

Unlimited users:
reza2022

โ ุฎุฑูุฌ ุฎูุงุตู ุฑูุฒุงูู
Summary - 1404-10-06

Admins:
- admin58586: 70.00 GB | unlimited: 1
- cheaterin: 0.00 GB | unlimited: 1
- router: 250.00 GB | unlimited: 0

Total all: 320.00 GB | unlimited total: 2

๐ ูุตุจ ุณุฑุน (ูพุดููุงุฏ)

โ ููุท ุจุง ณ ุฏุณุชูุฑ ูุตุจ ูโุดูุฏ:

git clone https://github.com/lastdejavu/pasarguard-admin-report.git
cd pasarguard-admin-report
sudo bash install.sh

โ install.sh ฺู ฺฉุงุฑูุง ุงูุฌุงู ูโุฏูุฏุ

ูุตุจโฺฉููุฏู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ:

ูพฺฉุฌโูุง ุถุฑูุฑ ุฑุง ูุตุจ ูโฺฉูุฏ (python, pip, venv, cron, mysql-client)

ูพุฑูฺู ุฑุง ุฏุฑ ูุณุฑ ุงุณุชุงูุฏุงุฑุฏ /opt/pasarguard-admin-report ูุตุจ ูโฺฉูุฏ

Virtualenv ูโุณุงุฒุฏ ู requirements.txt ุฑุง ูุตุจ ูโฺฉูุฏ

ุจุง Wizardุ ูุงู .env ุฑุง ูโุณุงุฒุฏ

Cron Job ูุง ุฑุง ุงุถุงูู ูโฺฉูุฏ (Daily/Weekly/Monthly)

(ุงุฎุชุงุฑ) Trigger ูุง ุฏุชุงุจุณ ุฑุง ุงุฒ triggers.sql ูุตุจ ูโฺฉูุฏ

(ุงุฎุชุงุฑ) ฺฉ ุชุณุช ุงุฌุฑุง ูโฺฉูุฏ

โ๏ธ ุชูุธูุงุช (Configuration)

ุฏุฑ ุฒูุงู ูุตุจุ ุงุฒ ุดูุง ุงู ููุงุฑุฏ ูพุฑุณุฏู ูโุดูุฏ:

MySQL Host / Port / Username / Password / Database

Telegram Bot Token

Telegram Chat ID

Timezone (ูพุดโูุฑุถ: Asia/Tehran)

ุชูุธูุงุช ุฏุฑ ูุงู .env ุฐุฎุฑู ูโุดูุฏ:

MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASS=YOUR_PASSWORD
MYSQL_DB=pasarguard

TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN
TELEGRAM_CHAT_ID=YOUR_CHAT_ID

TZ=Asia/Tehran

โฐ Cron Jobs (ุฒูุงูโุจูุฏ ุฎูุฏฺฉุงุฑ)

ุจุนุฏ ุงุฒ ูุตุจุ ฺฉุฑููโูุง ุฒุฑ ุงุถุงูู ูโุดูุฏ:

Daily โ ูุฑ ุฑูุฒ ุณุงุนุช 00:05

Weekly โ ูุฑ ุดูุจู ุณุงุนุช 00:10

Monthly โ ุฑูุฒ ฑ ูุฑ ูุงู ุณุงุนุช 00:15

ุจุฑุง ูุดุงูุฏู ฺฉุฑููโูุง:

crontab -l

โ๏ธ Trigger ูุง ุฏุชุงุจุณ (ุฎู ููู)

ุงู ูพุฑูฺู ุจุฑุง ฺฏุฒุงุฑุด ุฏูู ูุงุฒ ุฏุงุฑุฏ ุชุบุฑุงุช ุฌุฏูู users ุฏุงุฎู ุฌุฏูู users_logs ุซุจุช ุดูุฏ.

โ ุงฺฏุฑ ูพูู ุดูุง ุจู ุตูุฑุช ูพุดโูุฑุถ users_logs ุฑุง ฺฉุงูู ูพุฑ ููโฺฉูุฏุ ุจุงุฏ Trigger ูุง ูุตุจ ุดููุฏ.
๐ ูุงู ุขูุงุฏู ุฏุฑ ูพุฑูฺู ูุฌูุฏ ุฏุงุฑุฏ: triggers.sql

ูุตุจ Trigger ูุง (ุฏุณุช)
mysql -u root -p -h 127.0.0.1 -D pasarguard < triggers.sql


โ ุง ููฺฏุงู ุงุฌุฑุง install.shุ ุงฺฏุฑ ฺฏุฒูู ูุตุจ Trigger ุฑุง ุชุงุฏ ฺฉูุฏุ ุฎูุฏุด ูุตุจ ูโฺฉูุฏ.

๐งช ุงุฌุฑุง ุฏุณุช ุจุฑุง ุชุณุช
cd /opt/pasarguard-admin-report
source .venv/bin/activate

python pasarguard_admin_report.py
python pasarguard_admin_report.py weekly
python pasarguard_admin_report.py monthly

๐ ูุณุฑ ูุงฺฏโูุง

Daily log: /var/log/pasarguard_admin_report.log

Weekly log: /var/log/pasarguard_weekly.log

Monthly log: /var/log/pasarguard_monthly.log

๐๏ธ ุฑูุน ุฎุทุงูุง ุฑุงุฌ
โ ุฎุทุง MySQL Connection refused

ุนู ุฑู ููู ุณุฑูุฑุ MySQL ุฑู ูพูุฑุช 3306 ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช (ุง ุฏุชุงุจุณ ุฑู ุณุฑูุฑ ุฏฺฏุฑ ุงุณุช).

ุจุฑุฑุณ ูพูุฑุช:

ss -tulnp | grep 3306


ุงฺฏุฑ ุฏุชุงุจุณ ุฑู ุณุฑูุฑ ุฏฺฏุฑ ุงุณุชุ ููุฏุงุฑ MYSQL_HOST ุฑุง IP ููุงู ุณุฑูุฑ ูุฑุงุฑ ุฏูุฏ.

๐ License
MIT License โ
Use it freely and share improvements.
โ triggers.sql (ุญุฑููโุง/ุงุณุชุงูุฏุงุฑุฏ โ ุฌุงฺฏุฒู ฺฉู triggers.sql ฺฉู)

ุงู ูุณุฎู ูู Drop ุฏุงุฑุฏ ูู DELIMITER ุฏุฑุณุช ุฏุงุฑุฏ ู ูู UNLIMITED ุฑุง ุฏูู ุซุจุช ูโฺฉูุฏ (ููุช data_limit ุจุดูุฏ NULL ุง 0).

-- PasarGuard Admin Report - Triggers
-- This script creates triggers to log INSERT/UPDATE/DELETE on `users` into `users_logs`

DELIMITER $$

DROP TRIGGER IF EXISTS `InsertLog` $$
DROP TRIGGER IF EXISTS `UpdateLog` $$
DROP TRIGGER IF EXISTS `DeleteLog` $$

CREATE TRIGGER `InsertLog`
AFTER INSERT ON `users`
FOR EACH ROW
BEGIN
  INSERT INTO users_logs (
      admin_id,
      user_id,
      data_limit_old,
      data_limit_new,
      expire_old,
      expire_new,
      used_traffic_old,
      used_traffic_new,
      action,
      log_date
  )
  VALUES (
      NEW.admin_id,
      NEW.id,
      NULL,
      NEW.data_limit,
      NULL,
      NEW.expire,
      NULL,
      NEW.used_traffic,
      'INSERT',
      NOW()
  );
END $$

CREATE TRIGGER `UpdateLog`
AFTER UPDATE ON `users`
FOR EACH ROW
BEGIN
  INSERT INTO users_logs (
      admin_id,
      user_id,
      data_limit_old,
      data_limit_new,
      expire_old,
      expire_new,
      used_traffic_old,
      used_traffic_new,
      action,
      log_date
  )
  VALUES (
      NEW.admin_id,
      NEW.id,
      OLD.data_limit,
      NEW.data_limit,
      OLD.expire,
      NEW.expire,
      OLD.used_traffic,
      NEW.used_traffic,
      CASE
          WHEN (OLD.data_limit <> NEW.data_limit) AND (NEW.data_limit IS NULL OR NEW.data_limit = 0) THEN 'UNLIMITED'
          WHEN OLD.data_limit <> NEW.data_limit THEN 'CHANGE_LIMIT'
          WHEN OLD.expire <> NEW.expire THEN 'CHANGE_EXPIRE'
          WHEN OLD.used_traffic <> NEW.used_traffic AND NEW.used_traffic = 0 THEN 'RESET_USAGE'
          ELSE 'UPDATE'
      END,
      NOW()
  );
END $$

CREATE TRIGGER `DeleteLog`
AFTER DELETE ON `users`
FOR EACH ROW
BEGIN
  INSERT INTO users_logs (
      admin_id,
      user_id,
      data_limit_old,
      data_limit_new,
      expire_old,
      expire_new,
      used_traffic_old,
      used_traffic_new,
      action,
      log_date
  )
  VALUES (
      OLD.admin_id,
      OLD.id,
      OLD.data_limit,
      NULL,
      OLD.expire,
      NULL,
      OLD.used_traffic,
      NULL,
      'DELETE',
      NOW()
  );
END $$

DELIMITER ;
